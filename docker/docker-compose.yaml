version: '2'

services:
  whale:
    hostname: monitor.local
    build:
      context: .
      dockerfile: Dockerfile-monitor
    command: >
      bash -c "true
      ; tail -F /dev/null"
    user: 'root'
    volumes:
     - ./data:/data
    working_dir: /data/monitor
  dolphin:
    hostname: dolphin.local
    build:
      context: .
      dockerfile: Dockerfile-master
    command: >
      bash -c "chown -R mysql:mysql /data/master /var/run/mysqld /var/lib/mysql
      ; usermod -d /data/master/db/ mysql
      ; /etc/init.d/mysql start
      ; mysql -u root -ppassword -P 33061 -e \"GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'password'\"
      ; mysql -u root -ppassword -P 33061 -e \"create user 'slaveuser'@'%' identified by 'slavepassword'\"
      ; mysql -u root -ppassword -P 33061 -e \"grant replication slave on *.* to 'slaveuser'@'%'\"
      ; mysql -u root -ppassword -P 33061 -e \"create database animals\"
      ; mysql -u root -ppassword -P 33061 -e \"create table animals.list (name varchar(20))\"
      ; mysqldump -u root -ppassword -P 33061 --all-databases --master-data --flush-privileges > /data/master/backup/masterdump.sql
      ; tail -F /dev/null"
    user: 'root'
    ports:
     - "33061:33061"
    volumes:
     - ./data:/data
     - ./etc-mysql-mysql.conf.d-mysql.cnf-master:/etc/mysql/mysql.conf.d/mysqld.cnf
     - ./etc-mysql-debian.cnf-master:/etc/mysql/debian.cnf
    working_dir: /data/master
    environment:
     - MYSQL_ROOT_PASSWORD=root
  goldfish:
    hostname: goldfish.local
    build:
      context: .
      dockerfile: Dockerfile-slave
    command: >
      bash -c "chown -R mysql:mysql /data/slave /var/run/mysqld /var/lib/mysql
      ; usermod -d /data/slave/db/ mysql
      ; /etc/init.d/mysql start
      ; mysql -u root -ppassword -P 33062 -e \"ALTER USER 'root'@'%' IDENTIFIED BY 'password'\"
      ; mysql -u root -ppassword -P 33062 -e \"GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'password'\"
      ; tail -F /dev/null"
    user: 'root'
    ports:
     - "33062:33062"
    volumes:
     - ./data:/data
     - ./etc-mysql-mysql.conf.d-mysql.cnf-slave:/etc/mysql/mysql.conf.d/mysqld.cnf
     - ./etc-mysql-debian.cnf-slave:/etc/mysql/debian.cnf
    working_dir: /data/slave
    environment:
     - MYSQL_ROOT_PASSWORD=root
